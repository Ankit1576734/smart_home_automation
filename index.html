<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom toggle switch styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4A90E2;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4A90E2;
        }
        .channel-card {
            transition: all 0.3s ease-in-out;
        }
        .channel-card.on {
            background-color: #3f3f46; /* zinc-700 */
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
            transform: translateY(-2px);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm">
        <div class="bg-zinc-800 p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-center mb-6">Smart Home Login</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-zinc-400 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 bg-zinc-700 border-zinc-600 text-white leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-zinc-400 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 bg-zinc-700 border-zinc-600 text-white mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="auth-error" class="text-red-500 text-xs italic mb-4 h-4"></div>
                <div class="flex items-center justify-between gap-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                        Log In
                    </button>
                    <button type="button" id="signup-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full transition duration-300">
                        Sign Up
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Main Content -->
    <div id="main-content" class="w-full max-w-4xl hidden">
        <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-2">
                 <p id="connectionStatus" class="text-xs text-zinc-500 h-4"></p>
                 <div>
                    <span id="user-email" class="text-zinc-400 text-sm mr-4"></span>
                    <button id="logout-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-lg transition duration-300">Logout</button>
                 </div>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Smart Home Control</h1>
            <p class="text-zinc-400">Welcome back! Manage your devices below.</p>
        </header>
        
        <div class="flex justify-center gap-4 mb-8">
            <button id="master-on" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Turn All On</button>
            <button id="master-off" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Turn All Off</button>
        </div>

        <main id="channels-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <!-- Channel cards will be inserted here by JavaScript -->
        </main>
        
        <footer class="mt-8 text-center">
            <h2 class="text-xl font-semibold mb-2">Activity Log</h2>
            <div id="status-log" class="h-24 bg-zinc-800 rounded-lg p-3 text-left overflow-y-auto text-sm text-zinc-300">
                <p>System initialized. Please log in.</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeaYRq2zOyb-YtJGJ3So4xwyoot21X6oY",
            authDomain: "home-automation-ded78.firebaseapp.com",
            databaseURL: "https://home-automation-ded78-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "home-automation-ded78",
            storageBucket: "home-automation-ded78.appspot.com",
            messagingSenderId: "252098473315",
            appId: "1:252098473315:web:fca6057a1cb818fc0d7756",
            measurementId: "G-0NEVG368YJ"
        };
        
        const channels = [
            { id: 1, name: 'Living Room Light', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7c0-2.2-1.8-4-4-4S10 4.8 10 7c0 2 .3 3.2 1.5 4.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>` },
            { id: 2, name: 'Kitchen Appliance', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/><path d="M16 8.9c-1.3 1.3-3.2 1.3-4.5 0-1.3-1.3-1.3-3.2 0-4.5s3.2-1.3 4.5 0c1.3 1.3 1.3 3.2 0 4.5Z"/><path d="M18 14.2c-1.5-1.5-3.8-1.5-5.3 0-1.5 1.5-1.5 3.8 0 5.3 1.5 1.5 3.8 1.5 5.3 0 1.5-1.5 1.5-3.8 0-5.3Z"/></svg>` },
            { id: 3, name: 'Bedroom Lamp', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 22v-2"/></svg>` },
            { id: 4, name: 'Garage Door', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14V6c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v8"/><path d="M19 14v2c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-2"/><path d="M5 14h14"/><path d="M12 14v-4"/></svg>` },
            { id: 5, name: 'Thermostat', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>` },
            { id: 6, name: 'Garden Sprinkler', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.4s-3.6-2.6-3.6-2.6A4 4 0 0 0 8 7c0 2-1 3.9-3 5.4S2 13 2 15a7 7 0 0 0 7 7"/><path d="M12 12v10"/></svg>` },
            { id: 7, name: 'Security Cam', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3Z"/><circle cx="12" cy="13" r="3"/></svg>` },
            { id: 8, name: 'Main Power', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>` }
        ];

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailDisplay = document.getElementById('user-email');
        const channelsGrid = document.getElementById('channels-grid');
        const statusLog = document.getElementById('status-log');
        const masterOnBtn = document.getElementById('master-on');
        const masterOffBtn = document.getElementById('master-off');
        const connectionStatus = document.getElementById('connectionStatus');

        // --- Functions ---
        
        function createChannelCards() {
            channelsGrid.innerHTML = '';
            channels.forEach(channel => {
                const card = document.createElement('div');
                card.className = 'channel-card bg-zinc-800 p-4 rounded-lg flex flex-col items-center justify-center aspect-square';
                card.id = `channel-${channel.id}`;
                card.innerHTML = `
                    <div class="text-zinc-400 mb-2">${channel.icon}</div>
                    <h3 class="font-semibold text-center text-sm mb-4">${channel.name}</h3>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle-${channel.id}" id="toggle-${channel.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="toggle-${channel.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-zinc-600 cursor-pointer"></label>
                    </div>`;
                channelsGrid.appendChild(card);
            });
        }
        
        function logStatus(message) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusLog.insertBefore(p, statusLog.firstChild);
            if (statusLog.children.length > 20) {
                statusLog.removeChild(statusLog.lastChild);
            }
        }

        function renderChannelStates(states) {
            if (!states) return;
            channels.forEach(channel => {
                const is_on = states[`relay${channel.id}`] || false;
                const checkbox = document.getElementById(`toggle-${channel.id}`);
                const card = document.getElementById(`channel-${channel.id}`);
                if (checkbox && card) {
                    checkbox.checked = is_on;
                    card.classList.toggle('on', is_on);
                }
            });
        }

        async function updateChannelState(channelId, newState) {
            const relayRef = ref(db, 'relay' + channelId);
            try {
                await set(relayRef, newState);
                const channelName = channels.find(c => c.id === channelId).name;
                logStatus(`${channelName} turned ${newState ? 'ON' : 'OFF'}.`);
            } catch (error) {
                console.error("Error updating channel state: ", error);
                logStatus(`Error updating ${channelName}.`);
            }
        }
        
        async function updateAllChannels(newState) {
            const updates = {};
            channels.forEach(channel => {
                updates[`relay${channel.id}`] = newState;
            });
            try {
                await set(ref(db), updates);
                logStatus(`All channels turned ${newState ? 'ON' : 'OFF'}.`);
            } catch (error) {
                console.error("Error updating all channels: ", error);
                logStatus(`Error turning all channels ${newState ? 'ON' : 'OFF'}.`);
            }
        }

        function addToggleListeners() {
            channels.forEach(channel => {
                const toggle = document.getElementById(`toggle-${channel.id}`);
                if(toggle) {
                    toggle.addEventListener('change', (e) => {
                        updateChannelState(channel.id, e.target.checked);
                    });
                }
            });
        }
        
        // --- App Initialization ---
        createChannelCards();
        addToggleListeners();
        masterOnBtn.addEventListener('click', () => updateAllChannels(true));
        masterOffBtn.addEventListener('click', () => updateAllChannels(false));

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                loginPage.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                logStatus(`User ${user.email} logged in.`);
                
                // Set up Realtime Database listener for authenticated user
                const dbRef = ref(db);
                onValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        renderChannelStates(data);
                        connectionStatus.textContent = "Connected to Realtime Database.";
                        connectionStatus.classList.remove('text-zinc-500', 'text-red-500');
                        connectionStatus.classList.add('text-green-500');
                    } else {
                        logStatus("No data found in database. Initializing relays to OFF.");
                        updateAllChannels(false);
                    }
                }, (error) => {
                    console.error("Firebase read failed: " + error.name);
                    logStatus("Error connecting to database.");
                    connectionStatus.textContent = "Error: Could not connect to database.";
                    connectionStatus.classList.remove('text-zinc-500', 'text-green-500');
                    connectionStatus.classList.add('text-red-500');
                });

            } else {
                // User is signed out
                mainContent.classList.add('hidden');
                loginPage.classList.remove('hidden');
                userEmailDisplay.textContent = '';
                connectionStatus.textContent = '';
            }
        });

        // Event Listeners for Auth forms
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            authError.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            logStatus("User logged out.");
        });

    </script>
</body>
</html>

